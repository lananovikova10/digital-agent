{% extends "base.html" %}

{% block title %}Generate Report - Weekly Intelligence Agent{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <div class="bg-white rounded-lg shadow-lg p-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-6">
            <i class="fas fa-plus-circle mr-2 text-blue-600"></i>
            Generate New Report
        </h1>
        
        <form id="generateForm" class="space-y-6">
            <div>
                <label for="topics" class="block text-sm font-medium text-gray-700 mb-2">
                    Topics to Analyze
                </label>
                <input type="text" 
                       id="topics" 
                       name="topics" 
                       placeholder="e.g., AI, machine learning, fintech, MCP"
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                       required>
                <p class="text-sm text-gray-500 mt-1">
                    Enter topics separated by commas. The agent will search for relevant articles and generate insights.
                </p>
            </div>

            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <h3 class="font-semibold text-blue-900 mb-2">
                    <i class="fas fa-info-circle mr-1"></i>
                    What happens next?
                </h3>
                <ul class="text-sm text-blue-800 space-y-1">
                    <li>• Searches multiple sources (Hacker News, Reddit, Y Combinator, etc.)</li>
                    <li>• Analyzes and ranks articles by relevance and quality</li>
                    <li>• Generates executive summary with strategic insights</li>
                    <li>• Provides actionable recommendations and source links</li>
                </ul>
            </div>

            <button type="submit" 
                    id="generateBtn"
                    class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors font-medium">
                <i class="fas fa-cog mr-2"></i>
                Generate Intelligence Report
            </button>
        </form>

        <div id="progress" class="hidden mt-6">
            <div class="bg-gray-200 rounded-full h-2 mb-4">
                <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%" id="progressBar"></div>
            </div>
            <div class="text-center">
                <div class="inline-flex items-center text-blue-600">
                    <i class="fas fa-spinner fa-spin mr-2"></i>
                    <span id="progressText">Initializing...</span>
                </div>
            </div>
        </div>

        <div id="result" class="hidden mt-6"></div>
    </div>
</div>

<script>
document.getElementById('generateForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const topics = document.getElementById('topics').value.split(',').map(t => t.trim()).filter(t => t);
    const generateBtn = document.getElementById('generateBtn');
    const progress = document.getElementById('progress');
    const result = document.getElementById('result');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    
    // Show progress
    generateBtn.disabled = true;
    generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Generating...';
    progress.classList.remove('hidden');
    result.classList.add('hidden');
    
    // Simulate progress
    let progressValue = 0;
    const progressSteps = [
        'Fetching articles from sources...',
        'Processing and enriching content...',
        'Ranking articles by relevance...',
        'Generating AI summary...',
        'Composing final report...',
        'Finalizing report...'
    ];
    
    const progressInterval = setInterval(() => {
        if (progressValue < 90) {
            progressValue += Math.random() * 15;
            progressBar.style.width = Math.min(progressValue, 90) + '%';
            const stepIndex = Math.floor((progressValue / 90) * progressSteps.length);
            progressText.textContent = progressSteps[Math.min(stepIndex, progressSteps.length - 1)];
        }
    }, 1000);
    
    try {
        const response = await fetch('/api/reports/generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ topics: topics })
        });
        
        const data = await response.json();
        
        clearInterval(progressInterval);
        progressBar.style.width = '100%';
        progressText.textContent = 'Report generated successfully!';
        
        setTimeout(() => {
            if (response.ok) {
                result.innerHTML = `
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <div class="flex items-center mb-2">
                            <i class="fas fa-check-circle text-green-600 mr-2"></i>
                            <h3 class="font-semibold text-green-900">Report Generated Successfully!</h3>
                        </div>
                        <p class="text-green-800 mb-4">Your intelligence report has been created and is ready to view.</p>
                        <div class="flex gap-3">
                            <a href="/reports/${data.report_id}" 
                               class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition-colors">
                                <i class="fas fa-eye mr-1"></i>View Report
                            </a>
                            <a href="/" 
                               class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 transition-colors">
                                <i class="fas fa-list mr-1"></i>All Reports
                            </a>
                        </div>
                    </div>
                `;
            } else {
                throw new Error(data.detail || 'Failed to generate report');
            }
            result.classList.remove('hidden');
        }, 1000);
        
    } catch (error) {
        clearInterval(progressInterval);
        result.innerHTML = `
            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                <div class="flex items-center mb-2">
                    <i class="fas fa-exclamation-circle text-red-600 mr-2"></i>
                    <h3 class="font-semibold text-red-900">Generation Failed</h3>
                </div>
                <p class="text-red-800">${error.message}</p>
            </div>
        `;
        result.classList.remove('hidden');
    } finally {
        generateBtn.disabled = false;
        generateBtn.innerHTML = '<i class="fas fa-cog mr-2"></i>Generate Intelligence Report';
        setTimeout(() => {
            progress.classList.add('hidden');
        }, 2000);
    }
});
</script>
{% endblock %}